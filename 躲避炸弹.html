<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç»ˆæç‚¸å¼¹èº²é¿å¤§å†’é™©</title>
    <style>
        :root {
            --primary-color: #FFD700;
            --secondary-color: #FF4500;
            --bg-gradient: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
            --game-bg: rgba(0, 0, 0, 0.5);
            --text-shadow: 0 0 10px rgba(0, 0, 0, 0.7);
            --box-shadow: 0 0 30px rgba(0, 0, 0, 0.5);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: 'Arial Rounded MT Bold', 'Arial', sans-serif;
            background: var(--bg-gradient);
            min-height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            touch-action: manipulation;
            transition: all 0.3s ease;
        }
        
        #game-wrapper {
            position: relative;
            width: 100%;
            max-width: 800px;
            height: 100vh;
            max-height: 600px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        #game-container {
            position: relative;
            width: 100%;
            height: 100%;
            background-color: var(--game-bg);
            border-radius: 20px;
            overflow: hidden;
            box-shadow: var(--box-shadow);
            border: 3px solid rgba(255, 255, 255, 0.2);
            will-change: transform;
            transition: all 0.3s ease;
        }
        
        #player {
            position: absolute;
            width: 50px;
            height: 50px;
            bottom: 30px;
            left: 175px;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="45" fill="%23FFD700"/><circle cx="35" cy="40" r="8" fill="%23333"/><circle cx="65" cy="40" r="8" fill="%23333"/><path d="M30,65 Q50,80 70,65" stroke="%23333" stroke-width="4" fill="none"/></svg>') no-repeat center/contain;
            z-index: 10;
            transition: transform 0.1s cubic-bezier(0.68, -0.55, 0.27, 1.55);
            will-change: transform, left;
        }
        
        .bomb {
            position: absolute;
            width: 40px;
            height: 40px;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="45" fill="%23333"/><circle cx="50" cy="50" r="30" fill="%23FF4500"/><path d="M30,25 L40,15 L50,25 L60,15 L70,25" stroke="%23FFD700" stroke-width="3" fill="none"/></svg>') no-repeat center/contain;
            z-index: 5;
            will-change: transform, top;
        }
        
        .treasure {
            position: absolute;
            width: 35px;
            height: 35px;
            z-index: 6;
            will-change: transform, top;
            animation: float 2s ease-in-out infinite;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        .treasure.heart {
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><path d="M50,30 Q30,10 10,30 Q-5,50 30,80 Q50,100 70,80 Q105,50 90,30 Q70,10 50,30 Z" fill="%23FF0000"/></svg>') no-repeat center/contain;
        }
        
        .treasure.speed-up {
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="40" fill="%2300FF00"/><text x="50" y="60" font-size="40" text-anchor="middle" fill="white">â†‘</text></svg>') no-repeat center/contain;
        }
        
        .treasure.speed-down {
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="40" fill="%230000FF"/><text x="50" y="60" font-size="40" text-anchor="middle" fill="white">â†“</text></svg>') no-repeat center/contain;
        }
        
        .treasure.key {
            font-size: 35px;
            text-align: center;
            line-height: 35px;
        }
        
        .treasure.coin {
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="40" fill="%23FFD700"/><circle cx="50" cy="50" r="30" fill="%23FFEE00"/><text x="50" y="60" font-size="30" text-anchor="middle" fill="%238B8000">$</text></svg>') no-repeat center/contain;
        }
        
        .explosion {
            position: absolute;
            width: 100px;
            height: 100px;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><path d="M50,0 L60,40 L100,50 L60,60 L50,100 L40,60 L0,50 L40,40 Z" fill="%23FF4500"/></svg>') no-repeat center/contain;
            opacity: 0;
            z-index: 20;
            animation: explode 0.5s forwards;
            will-change: transform, opacity;
        }
        
        @keyframes explode {
            0% { transform: scale(0.1); opacity: 0.8; }
            100% { transform: scale(1.5); opacity: 0; }
        }
        
        .hud {
            position: absolute;
            font-weight: bold;
            color: white;
            text-shadow: var(--text-shadow);
            will-change: contents;
            font-size: 20px;
            padding: 5px 10px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 10px;
            display: flex;
            align-items: center;
            gap: 5px;
            z-index: 15;
        }
        
        #score-display {
            top: 20px;
            left: 20px;
        }
        
        #time-display {
            top: 20px;
            right: 20px;
        }
        
        #keys-display {
            top: 60px;
            right: 20px;
        }
        
        #coins-display {
            top: 60px;
            left: 20px;
        }
        
        #game-over, #start-screen, #shop-screen, #new-record-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 30;
            backdrop-filter: blur(5px);
        }
        
        .screen-title {
            font-size: 48px;
            margin-bottom: 20px;
            text-shadow: var(--text-shadow);
            color: var(--primary-color);
            text-align: center;
        }
        
        .screen-subtitle {
            font-size: 24px;
            margin-bottom: 30px;
            text-align: center;
            max-width: 80%;
        }
        
        .btn {
            padding: 15px 30px;
            font-size: 20px;
            border: none;
            border-radius: 50px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px;
            background: linear-gradient(45deg, var(--secondary-color), #FF8C00);
            box-shadow: 0 5px 15px rgba(255, 69, 0, 0.4);
        }
        
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(255, 69, 0, 0.6);
        }
        
        .btn-secondary {
            background: linear-gradient(45deg, #1E90FF, #00BFFF);
            box-shadow: 0 5px 15px rgba(30, 144, 255, 0.4);
        }
        
        .btn-small {
            padding: 8px 16px;
            font-size: 16px;
            margin: 5px;
        }
        
        .instructions {
            margin-top: 20px;
            text-align: center;
            max-width: 300px;
            line-height: 1.5;
            font-size: 16px;
        }
        
        .particle {
            position: absolute;
            width: 10px;
            height: 10px;
            background-color: rgba(255, 255, 255, 0.7);
            border-radius: 50%;
            pointer-events: none;
            will-change: transform, opacity;
        }
        
        .effect-text {
            position: absolute;
            color: white;
            font-size: 24px;
            font-weight: bold;
            text-shadow: var(--text-shadow);
            z-index: 25;
            animation: float-up 1s forwards;
        }
        
        @keyframes float-up {
            0% { transform: translateY(0); opacity: 1; }
            100% { transform: translateY(-50px); opacity: 0; }
        }
        
        #shop-items {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
            max-height: 300px;
            overflow-y: auto;
            padding: 10px;
            width: 90%;
        }
        
        .shop-item {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 15px;
            width: 120px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        
        .shop-item:hover {
            transform: translateY(-5px);
            background: rgba(255, 255, 255, 0.2);
        }
        
        .shop-item.selected {
            border-color: var(--primary-color);
            box-shadow: 0 0 15px var(--primary-color);
        }
        
        .shop-item-icon {
            font-size: 40px;
            margin-bottom: 10px;
        }
        
        .shop-item-price {
            color: var(--primary-color);
            font-weight: bold;
        }
        
        .orientation-warning {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-gradient);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
            text-align: center;
            padding: 20px;
        }
        
        .orientation-warning h2 {
            font-size: 28px;
            margin-bottom: 20px;
            color: white;
        }
        
        .orientation-warning p {
            font-size: 18px;
            margin-bottom: 30px;
            color: white;
        }
        
        .rotate-icon {
            font-size: 60px;
            margin-bottom: 20px;
            animation: rotate 2s linear infinite;
        }
        
        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(90deg); }
        }
        
        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            background-color: #f00;
            border-radius: 50%;
            animation: confetti-fall 5s linear forwards;
            z-index: 40;
        }
        
        @keyframes confetti-fall {
            0% { transform: translateY(-100px) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(360deg); opacity: 0; }
        }
        
        #confirm-dialog {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            padding: 20px;
            border-radius: 15px;
            z-index: 50;
            display: none;
            flex-direction: column;
            align-items: center;
            border: 2px solid var(--primary-color);
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
            max-width: 80%;
        }
        
        #confirm-dialog p {
            margin-bottom: 20px;
            text-align: center;
            font-size: 18px;
        }
        
        #confirm-dialog-buttons {
            display: flex;
            gap: 10px;
        }
        
        @media (max-width: 600px) {
            .screen-title {
                font-size: 36px;
            }
            
            .screen-subtitle {
                font-size: 18px;
            }
            
            .btn {
                padding: 12px 24px;
                font-size: 18px;
            }
            
            .hud {
                font-size: 16px;
            }
        }
        
        @media (max-height: 500px) {
            .orientation-warning {
                display: flex;
            }
            
            #game-wrapper {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div id="game-wrapper">
        <div id="game-container">
            <div id="score-display" class="hud">åˆ†æ•°: 0</div>
            <div id="time-display" class="hud">æ—¶é—´: 0</div>
            <div id="keys-display" class="hud">ğŸ”‘: 0</div>
            <div id="coins-display" class="hud">ğŸ’°: 0</div>
            <div id="player"></div>
            
            <div id="start-screen">
                <h1 class="screen-title">ç»ˆæç‚¸å¼¹èº²é¿å¤§å†’é™©</h1>
                <button id="start-btn" class="btn">å¼€å§‹æ¸¸æˆ</button>
                <button id="shop-btn" class="btn btn-secondary">çš®è‚¤å•†åº—</button>
                <button id="load-btn" class="btn btn-secondary">åŠ è½½å­˜æ¡£</button>
                <div class="instructions">
                    ä½¿ç”¨é”®ç›˜å·¦å³ç®­å¤´é”®æˆ–è§¦æ‘¸å±å¹•ç§»åŠ¨è§’è‰²<br>
                    èº²é¿ç‚¸å¼¹ï¼Œæ”¶é›†å®ç‰©ï¼<br>
                    â¤ï¸=å¤æ´» â†‘=åŠ é€Ÿ â†“=å‡é€Ÿ ğŸ”‘=é’¥åŒ™ ğŸ’°=é‡‘å¸
                </div>
            </div>
            
            <div id="game-over">
                <h2 class="screen-title">æ¸¸æˆç»“æŸ!</h2>
                <div class="screen-subtitle">
                    <p>å¾—åˆ†: <span id="final-score">0</span></p>
                    <p>æ”¶é›†é‡‘å¸: <span id="final-coins">0</span></p>
                    <p>æ”¶é›†é’¥åŒ™: <span id="final-keys">0</span></p>
                </div>
                <button id="restart-btn" class="btn">è¿”å›ä¸»ç•Œé¢</button>
                <button id="exit-btn" class="btn btn-secondary">ä¿å­˜å¹¶é€€å‡º</button>
            </div>
            
            <div id="shop-screen">
                <h2 class="screen-title">çš®è‚¤å•†åº—</h2>
                <div class="screen-subtitle">ä½ çš„é‡‘å¸: <span id="total-coins">0</span></div>
                <div id="shop-items">
                    <!-- çš®è‚¤å•†å“å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                </div>
                <button id="back-btn" class="btn">è¿”å›æ¸¸æˆ</button>
            </div>
            
            <div id="new-record-screen">
                <h2 class="screen-title">ğŸ‰ æ–°çºªå½•! ğŸ‰</h2>
                <div class="screen-subtitle">æ­å–œä½ åˆ›é€ äº†æ–°çš„é«˜åˆ†è®°å½•: <span id="record-score">0</span></div>
                <button id="continue-btn" class="btn">è¿”å›ä¸»ç•Œé¢</button>
            </div>
        </div>
    </div>
    
    <div class="orientation-warning">
        <div class="rotate-icon">ğŸ”„</div>
        <h2>è¯·æ—‹è½¬è®¾å¤‡</h2>
        <p>ä¸ºäº†è·å¾—æœ€ä½³æ¸¸æˆä½“éªŒï¼Œè¯·å°†è®¾å¤‡æ¨ªå±æ”¾ç½®</p>
    </div>
    
    <div id="confirm-dialog">
        <p id="confirm-message">ç¡®å®šè¦ä½¿ç”¨é’¥åŒ™å¤æ´»å—ï¼Ÿ</p>
        <div id="confirm-dialog-buttons">
            <button id="confirm-yes" class="btn btn-small">ç¡®å®š</button>
            <button id="confirm-no" class="btn btn-small btn-secondary">å–æ¶ˆ</button>
        </div>
    </div>

    <script>
        // æ¸¸æˆå˜é‡
        let gameRunning = false;
        let score = 0;
        let gameTime = 0;
        let gameSpeed = 1;
        let playerX = 175;
        let bombs = [];
        let treasures = [];
        let particles = [];
        let effectTexts = [];
        let animationId;
        let lastTime = 0;
        let bombLastTime = 0;
        let treasureLastTime = 0;
        let timeLastUpdate = 0;
        let keysPressed = {};
        let touchX = null;
        let keysCollected = 0;
        let coinsCollected = 0;
        let totalCoins = 0;
        let lives = 1;
        let speedEffectEndTime = 0;
        let gameWidth = 400;
        let gameHeight = 600;
        let playerSkin = 'default';
        let gameData = {
            totalCoins: 0,
            unlockedSkins: ['default'],
            selectedSkin: 'default',
            highScore: 0,
            baseSpeed: 1
        };
        
        // DOMå…ƒç´ 
        const gameContainer = document.getElementById('game-container');
        const player = document.getElementById('player');
        const scoreDisplay = document.getElementById('score-display');
        const timeDisplay = document.getElementById('time-display');
        const keysDisplay = document.getElementById('keys-display');
        const coinsDisplay = document.getElementById('coins-display');
        const startScreen = document.getElementById('start-screen');
        const gameOverScreen = document.getElementById('game-over');
        const shopScreen = document.getElementById('shop-screen');
        const newRecordScreen = document.getElementById('new-record-screen');
        const finalScoreDisplay = document.getElementById('final-score');
        const finalKeysDisplay = document.getElementById('final-keys');
        const finalCoinsDisplay = document.getElementById('final-coins');
        const recordScoreDisplay = document.getElementById('record-score');
        const totalCoinsDisplay = document.getElementById('total-coins');
        const shopItemsContainer = document.getElementById('shop-items');
        const startBtn = document.getElementById('start-btn');
        const restartBtn = document.getElementById('restart-btn');
        const exitBtn = document.getElementById('exit-btn');
        const shopBtn = document.getElementById('shop-btn');
        const loadBtn = document.getElementById('load-btn');
        const backBtn = document.getElementById('back-btn');
        const continueBtn = document.getElementById('continue-btn');
        const confirmDialog = document.getElementById('confirm-dialog');
        const confirmMessage = document.getElementById('confirm-message');
        const confirmYes = document.getElementById('confirm-yes');
        const confirmNo = document.getElementById('confirm-no');
        
        // çš®è‚¤æ•°æ®
        const skins = [
            { id: 'default', name: 'é»˜è®¤', price: 0, emoji: 'ğŸ˜€', color: '#FFD700' },
            { id: 'ninja', name: 'å¿è€…', price: 100, emoji: 'ğŸ¥·', color: '#333333' },
            { id: 'robot', name: 'æœºå™¨äºº', price: 200, emoji: 'ğŸ¤–', color: '#00AAFF' },
            { id: 'alien', name: 'å¤–æ˜Ÿäºº', price: 300, emoji: 'ğŸ‘½', color: '#00FF00' },
            { id: 'hero', name: 'è‹±é›„', price: 500, emoji: 'ğŸ¦¸', color: '#FF0000' },
            { id: 'king', name: 'å›½ç‹', price: 1000, emoji: 'ğŸ¤´', color: '#FFD700' }
        ];
        
        // å®ç‰©ç±»å‹
        const TREASURE_TYPES = [
            { type: 'heart', prob: 0.15, color: '#FF0000', value: 0 },      // å¤æ´»
            { type: 'speed-up', prob: 0.25, color: '#00FF00', value: 0 },   // åŠ é€Ÿ
            { type: 'speed-down', prob: 0.25, color: '#0000FF', value: 0 }, // å‡é€Ÿ
            { type: 'key', prob: 0.15, color: '#FFD700', value: 0 },        // é’¥åŒ™
            { type: 'coin', prob: 0.2, color: '#FFD700', value: 5 }         // é‡‘å¸
        ];
        
        // åˆå§‹åŒ–æ¸¸æˆ
        function initGame() {
            // è°ƒæ•´æ¸¸æˆåŒºåŸŸå°ºå¯¸
            adjustGameSize();
            
            score = 0;
            gameTime = 0;
            gameSpeed = gameData.baseSpeed;
            playerX = gameWidth / 2 - 25;
            keysCollected = 0;
            coinsCollected = 0;
            lives = 1;
            bombs = [];
            treasures = [];
            particles = [];
            effectTexts = [];
            keysPressed = {};
            touchX = null;
            speedEffectEndTime = 0;
            
            // æ¸…é™¤æ‰€æœ‰å…ƒç´ 
            document.querySelectorAll('.bomb, .treasure, .explosion, .particle, .effect-text').forEach(el => el.remove());
            
            // é‡ç½®ç©å®¶ä½ç½®å’Œçš®è‚¤
            updatePlayerSkin();
            player.style.left = playerX + 'px';
            player.style.transform = 'scale(1)';
            
            // æ›´æ–°æ˜¾ç¤º
            scoreDisplay.textContent = `åˆ†æ•°: ${score}`;
            timeDisplay.textContent = `æ—¶é—´: ${gameTime}`;
            keysDisplay.textContent = `ğŸ”‘: ${keysCollected}`;
            coinsDisplay.textContent = `ğŸ’°: ${coinsCollected}`;
            
            // é‡ç½®å®¹å™¨æ ·å¼
            gameContainer.style.boxShadow = '0 0 30px rgba(0, 0, 0, 0.5)';
        }
        
        // è°ƒæ•´æ¸¸æˆåŒºåŸŸå°ºå¯¸
        function adjustGameSize() {
            const isPortrait = window.innerHeight > window.innerWidth;
            
            if (isPortrait) {
                gameWidth = Math.min(400, window.innerWidth * 0.9);
                gameHeight = Math.min(600, window.innerHeight * 0.8);
            } else {
                gameWidth = Math.min(800, window.innerWidth * 0.8);
                gameHeight = Math.min(600, window.innerHeight * 0.9);
            }
            
            gameContainer.style.width = `${gameWidth}px`;
            gameContainer.style.height = `${gameHeight}px`;
        }
        
        // æ›´æ–°ç©å®¶çš®è‚¤
        function updatePlayerSkin() {
            const skin = skins.find(s => s.id === playerSkin) || skins[0];
            player.style.background = `url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="45" fill="${encodeURIComponent(skin.color)}"/><circle cx="35" cy="40" r="8" fill="%23333"/><circle cx="65" cy="40" r="8" fill="%23333"/><path d="M30,65 Q50,80 70,65" stroke="%23333" stroke-width="4" fill="none"/></svg>') no-repeat center/contain`;
        }
        
        // å¼€å§‹æ¸¸æˆ
        function startGame() {
            initGame();
            startScreen.style.display = 'none';
            gameOverScreen.style.display = 'none';
            shopScreen.style.display = 'none';
            newRecordScreen.style.display = 'none';
            gameRunning = true;
            lastTime = performance.now();
            bombLastTime = lastTime;
            treasureLastTime = lastTime;
            timeLastUpdate = lastTime;
            
            // å¼€å§‹æ¸¸æˆå¾ªç¯
            animationId = requestAnimationFrame(gameLoop);
        }
        
        // æ¸¸æˆä¸»å¾ªç¯
        function gameLoop(currentTime) {
            if (!gameRunning) return;
            
            const deltaTime = currentTime - lastTime;
            lastTime = currentTime;
            
            // æ›´æ–°æ¸¸æˆçŠ¶æ€
            updateGame(deltaTime, currentTime);
            
            // ç»§ç»­å¾ªç¯
            animationId = requestAnimationFrame(gameLoop);
        }
        
        // æ›´æ–°æ¸¸æˆçŠ¶æ€
        function updateGame(deltaTime, currentTime) {
            // å¤„ç†ç©å®¶ç§»åŠ¨
            handlePlayerMovement(deltaTime);
            
            // ç”Ÿæˆç‚¸å¼¹
            if (currentTime - bombLastTime > 1000 / gameSpeed) {
                createBomb();
                bombLastTime = currentTime;
            }
            
            // ç”Ÿæˆå®ç‰©
            if (currentTime - treasureLastTime > 3000 / gameSpeed) {
                createTreasure();
                treasureLastTime = currentTime;
            }
            
            // æ›´æ–°ç‚¸å¼¹ä½ç½®
            updateBombs(deltaTime);
            
            // æ›´æ–°å®ç‰©ä½ç½®
            updateTreasures(deltaTime);
            
            // æ›´æ–°ç²’å­
            updateParticles(deltaTime);
            
            // æ›´æ–°æ•ˆæœæ–‡æœ¬
            updateEffectTexts(deltaTime);
            
            // æ›´æ–°æ—¶é—´
            if (currentTime - timeLastUpdate > 1000) {
                gameTime++;
                timeDisplay.textContent = `æ—¶é—´: ${gameTime}`;
                timeLastUpdate = currentTime;
                
                // æ¯5ç§’å¢åŠ æ¸¸æˆé€Ÿåº¦ï¼ˆå¦‚æœæ²¡æœ‰é€Ÿåº¦æ•ˆæœï¼‰
                if (gameTime % 5 === 0 && currentTime > speedEffectEndTime) {
                    gameSpeed += 0.1;
                    // è§†è§‰åé¦ˆ
                    gameContainer.style.boxShadow = `0 0 30px rgba(255, ${Math.min(69 + gameTime*5, 255)}, 0, 0.7)`;
                    setTimeout(() => {
                        gameContainer.style.boxShadow = '0 0 30px rgba(0, 0, 0, 0.5)';
                    }, 300);
                    
                    createEffectText(gameWidth/2, gameHeight/2, 'éš¾åº¦æå‡!', '#FF4500');
                }
            }
            
            // æ£€æŸ¥é€Ÿåº¦æ•ˆæœæ˜¯å¦ç»“æŸ
            if (currentTime > speedEffectEndTime && speedEffectEndTime !== 0) {
                speedEffectEndTime = 0;
                gameSpeed = Math.max(gameData.baseSpeed, gameSpeed); // ç¡®ä¿é€Ÿåº¦ä¸ä½äºåŸºç¡€é€Ÿåº¦
                createEffectText(gameWidth/2, gameHeight/2, 'é€Ÿåº¦æ¢å¤æ­£å¸¸', '#FFFFFF');
            }
        }
        
        // å¤„ç†ç©å®¶ç§»åŠ¨
        function handlePlayerMovement(deltaTime) {
            const moveSpeed = 0.3 * deltaTime; // åŸºäºæ—¶é—´çš„ç§»åŠ¨é€Ÿåº¦
            
            if (keysPressed['ArrowLeft'] || (touchX !== null && touchX < playerX + 25 - 10)) {
                playerX = Math.max(0, playerX - moveSpeed);
                player.style.transform = 'translateX(-5px) rotate(-10deg)';
            } 
            else if (keysPressed['ArrowRight'] || (touchX !== null && touchX > playerX + 25 + 10)) {
                playerX = Math.min(gameWidth - 50, playerX + moveSpeed);
                player.style.transform = 'translateX(5px) rotate(10deg)';
            } 
            else {
                player.style.transform = 'translateX(0) rotate(0deg)';
            }
            
            player.style.left = playerX + 'px';
        }
        
        // æ›´æ–°ç‚¸å¼¹ä½ç½®
        function updateBombs(deltaTime) {
            const bombSpeed = 0.15 * deltaTime * gameSpeed;
            
            for (let i = bombs.length - 1; i >= 0; i--) {
                const bomb = bombs[i];
                const bombTop = parseFloat(bomb.style.top || '0') + bombSpeed;
                bomb.style.top = bombTop + 'px';
                
                // ç‚¸å¼¹è¶…å‡ºå±å¹•
                if (bombTop > gameHeight) {
                    bomb.remove();
                    bombs.splice(i, 1);
                    score++;
                    scoreDisplay.textContent = `åˆ†æ•°: ${score}`;
                    createParticles(bomb.offsetLeft + 20, bomb.offsetTop + 20, 5, '#00FF00');
                }
                
                // ç¢°æ’æ£€æµ‹
                if (
                    bombTop + 40 > gameHeight - 80 && 
                    bombTop < gameHeight - 30 &&
                    parseFloat(bomb.style.left) + 40 > playerX &&
                    parseFloat(bomb.style.left) < playerX + 50
                ) {
                    explodeBomb(bomb, i);
                    handlePlayerHit();
                }
            }
        }
        
        // æ›´æ–°å®ç‰©ä½ç½®
        function updateTreasures(deltaTime) {
            const treasureSpeed = 0.1 * deltaTime * gameSpeed;
            
            for (let i = treasures.length - 1; i >= 0; i--) {
                const treasure = treasures[i];
                const treasureTop = parseFloat(treasure.element.style.top || '0') + treasureSpeed;
                treasure.element.style.top = treasureTop + 'px';
                
                // å®ç‰©è¶…å‡ºå±å¹•
                if (treasureTop > gameHeight) {
                    treasure.element.remove();
                    treasures.splice(i, 1);
                }
                
                // ç¢°æ’æ£€æµ‹
                if (
                    treasureTop + 35 > gameHeight - 80 && 
                    treasureTop < gameHeight - 30 &&
                    parseFloat(treasure.element.style.left) + 35 > playerX &&
                    parseFloat(treasure.element.style.left) < playerX + 50
                ) {
                    collectTreasure(treasure, i);
                }
            }
        }
        
        // æ›´æ–°ç²’å­
        function updateParticles(deltaTime) {
            for (let i = particles.length - 1; i >= 0; i--) {
                const particle = particles[i];
                particle.y += particle.vy * deltaTime * 0.03;
                particle.x += particle.vx * deltaTime * 0.03;
                particle.life -= deltaTime * 0.1;
                
                const pElement = particle.element;
                pElement.style.top = particle.y + 'px';
                pElement.style.left = particle.x + 'px';
                pElement.style.opacity = particle.life / 100;
                
                if (particle.life <= 0) {
                    pElement.remove();
                    particles.splice(i, 1);
                }
            }
        }
        
        // æ›´æ–°æ•ˆæœæ–‡æœ¬
        function updateEffectTexts(deltaTime) {
            for (let i = effectTexts.length - 1; i >= 0; i--) {
                const text = effectTexts[i];
                text.duration -= deltaTime;
                text.element.style.opacity = Math.min(1, text.duration / 500);
                
                if (text.duration <= 0) {
                    text.element.remove();
                    effectTexts.splice(i, 1);
                }
            }
        }
        
        // åˆ›å»ºç‚¸å¼¹
        function createBomb() {
            if (!gameRunning) return;
            
            const bomb = document.createElement('div');
            bomb.className = 'bomb';
            const x = Math.random() * (gameWidth - 40);
            bomb.style.left = x + 'px';
            bomb.style.top = '-40px';
            gameContainer.appendChild(bomb);
            bombs.push(bomb);
        }
        
        // åˆ›å»ºå®ç‰©
        function createTreasure() {
            if (!gameRunning) return;
            
            // éšæœºé€‰æ‹©å®ç‰©ç±»å‹
            const rand = Math.random();
            let cumulativeProb = 0;
            let selectedType = null;
            
            for (const type of TREASURE_TYPES) {
                cumulativeProb += type.prob;
                if (rand <= cumulativeProb) {
                    selectedType = type;
                    break;
                }
            }
            
            if (!selectedType) selectedType = TREASURE_TYPES[0];
            
            const treasure = document.createElement('div');
            treasure.className = `treasure ${selectedType.type}`;
            
            if (selectedType.type === 'key') {
                treasure.textContent = 'ğŸ”‘';
            }
            
            const x = Math.random() * (gameWidth - 35);
            treasure.style.left = x + 'px';
            treasure.style.top = '-35px';
            gameContainer.appendChild(treasure);
            
            treasures.push({
                element: treasure,
                type: selectedType.type,
                color: selectedType.color,
                value: selectedType.value
            });
        }
        
        // æ”¶é›†å®ç‰©
        function collectTreasure(treasure, index) {
            const type = treasure.type;
            const color = treasure.color;
            const value = treasure.value;
            
            // åˆ›å»ºæ”¶é›†æ•ˆæœ
            createParticles(
                parseFloat(treasure.element.style.left) + 17.5, 
                parseFloat(treasure.element.style.top) + 17.5, 
                15, 
                color
            );
            
            // æ ¹æ®å®ç‰©ç±»å‹åº”ç”¨æ•ˆæœ
            switch(type) {
                case 'heart':
                    lives++;
                    createEffectText(playerX + 25, gameHeight - 100, '+1 ç”Ÿå‘½', color);
                    break;
                    
                case 'speed-up':
                    gameSpeed *= 1.5;
                    speedEffectEndTime = performance.now() + 5000; // 5ç§’æ•ˆæœ
                    createEffectText(playerX + 25, gameHeight - 100, 'é€Ÿåº¦æå‡!', color);
                    break;
                    
                case 'speed-down':
                    gameSpeed *= 0.7;
                    speedEffectEndTime = performance.now() + 5000; // 5ç§’æ•ˆæœ
                    createEffectText(playerX + 25, gameHeight - 100, 'é€Ÿåº¦é™ä½!', color);
                    break;
                    
                case 'key':
                    keysCollected++;
                    keysDisplay.textContent = `ğŸ”‘: ${keysCollected}`;
                    createEffectText(playerX + 25, gameHeight - 100, '+1 é’¥åŒ™', color);
                    break;
                    
                case 'coin':
                    coinsCollected += value;
                    coinsDisplay.textContent = `ğŸ’°: ${coinsCollected}`;
                    createEffectText(playerX + 25, gameHeight - 100, `+${value}é‡‘å¸`, color);
                    break;
            }
            
            // ç§»é™¤å®ç‰©
            treasure.element.remove();
            treasures.splice(index, 1);
            
            // æ’­æ”¾æ”¶é›†éŸ³æ•ˆ
            playSound('collect');
        }
        
        // ç‚¸å¼¹çˆ†ç‚¸
        function explodeBomb(bomb, index) {
            const explosion = document.createElement('div');
            explosion.className = 'explosion';
            explosion.style.left = (parseFloat(bomb.style.left) - 30) + 'px';
            explosion.style.top = (parseFloat(bomb.style.top) - 30) + 'px';
            gameContainer.appendChild(explosion);
            
            bomb.remove();
            bombs.splice(index, 1);
            
            // åˆ›å»ºçˆ†ç‚¸ç²’å­
            createParticles(
                parseFloat(bomb.style.left) + 20, 
                parseFloat(bomb.style.top) + 20, 
                30, 
                '#FF4500'
            );
            
            // ç§»é™¤çˆ†ç‚¸å…ƒç´ 
            setTimeout(() => {
                explosion.remove();
            }, 500);
            
            // æ’­æ”¾çˆ†ç‚¸éŸ³æ•ˆ
            playSound('explosion');
        }
        
        // å¤„ç†ç©å®¶è¢«å‡»ä¸­
        function handlePlayerHit() {
            // ç©å®¶è¢«å‡»ä¸­æ•ˆæœ
            player.style.transform = 'scale(1.5)';
            setTimeout(() => {
                player.style.transform = 'scale(1)';
            }, 200);
            
            lives--;
            
            if (lives <= 0) {
                // æ£€æŸ¥æ˜¯å¦æœ‰é’¥åŒ™å¯ä»¥å¤æ´»
                if (keysCollected > 0) {
                    showKeyConfirmDialog();
                } else {
                    gameOver();
                }
            } else {
                createEffectText(playerX + 25, gameHeight - 100, 'è¢«å‡»ä¸­!', '#FF0000');
            }
        }
        
        // æ˜¾ç¤ºé’¥åŒ™ç¡®è®¤å¯¹è¯æ¡†
        function showKeyConfirmDialog() {
            gameRunning = false;
            confirmMessage.textContent = `ä½ æœ‰ ${keysCollected} æŠŠé’¥åŒ™ï¼Œè¦ä½¿ç”¨ä¸€æŠŠé’¥åŒ™å¤æ´»å—ï¼Ÿ`;
            confirmDialog.style.display = 'flex';
            
            // ä¸´æ—¶ç¦ç”¨ç¡®è®¤æŒ‰é’®ï¼Œé˜²æ­¢å¤šæ¬¡ç‚¹å‡»
            confirmYes.disabled = true;
            setTimeout(() => {
                confirmYes.disabled = false;
            }, 500);
        }
        
        // ä½¿ç”¨é’¥åŒ™å¤æ´»
        function useKeyToRevive() {
            keysCollected--;
            lives = 1;
            keysDisplay.textContent = `ğŸ”‘: ${keysCollected}`;
            createEffectText(gameWidth/2, gameHeight/2, 'ä½¿ç”¨é’¥åŒ™å¤æ´»!', '#FFD700');
            playSound('revive');
            confirmDialog.style.display = 'none';
            gameRunning = true;
            lastTime = performance.now();
            animationId = requestAnimationFrame(gameLoop);
        }
        
        // ä¸ä½¿ç”¨é’¥åŒ™ï¼Œç»“æŸæ¸¸æˆ
        function continueWithoutRevive() {
            confirmDialog.style.display = 'none';
            gameOver();
        }
        
        // åˆ›å»ºç²’å­æ•ˆæœ
        function createParticles(x, y, count, color) {
            for (let i = 0; i < count; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.backgroundColor = color;
                particle.style.left = x + 'px';
                particle.style.top = y + 'px';
                gameContainer.appendChild(particle);
                
                particles.push({
                    element: particle,
                    x: x,
                    y: y,
                    vx: (Math.random() - 0.5) * 6,
                    vy: (Math.random() - 0.5) * 6,
                    life: 50 + Math.random() * 50
                });
            }
        }
        
        // åˆ›å»ºæ•ˆæœæ–‡æœ¬
        function createEffectText(x, y, text, color) {
            const element = document.createElement('div');
            element.className = 'effect-text';
            element.textContent = text;
            element.style.color = color;
            element.style.left = x + 'px';
            element.style.top = y + 'px';
            gameContainer.appendChild(element);
            
            effectTexts.push({
                element: element,
                duration: 1000
            });
        }
        
        // åˆ›å»ºå½©è‰²çº¸å±‘æ•ˆæœ
        function createConfetti() {
            for (let i = 0; i < 100; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = Math.random() * gameWidth + 'px';
                confetti.style.backgroundColor = `hsl(${Math.random() * 360}, 100%, 50%)`;
                confetti.style.animationDuration = (3 + Math.random() * 4) + 's';
                confetti.style.animationDelay = Math.random() * 2 + 's';
                gameContainer.appendChild(confetti);
                
                // åŠ¨ç”»ç»“æŸåç§»é™¤
                setTimeout(() => {
                    confetti.remove();
                }, 7000);
            }
        }
        
        // æ¸¸æˆç»“æŸ
        function gameOver() {
            gameRunning = false;
            cancelAnimationFrame(animationId);
            
            // æ›´æ–°æ¸¸æˆæ•°æ®
            gameData.totalCoins += coinsCollected;
            
            // æ£€æŸ¥æ˜¯å¦åˆ›é€ æ–°çºªå½•
            if (score > gameData.highScore) {
                const oldRecord = gameData.highScore;
                gameData.highScore = score;
                
                // æ˜¾ç¤ºæ–°çºªå½•ç•Œé¢
                recordScoreDisplay.textContent = score;
                createConfetti();
                newRecordScreen.style.display = 'flex';
                
                // æ’­æ”¾åº†ç¥éŸ³æ•ˆ
                playSound('celebration');
            } else {
                // æ²¡æœ‰æ–°çºªå½•ï¼Œç›´æ¥æ˜¾ç¤ºæ¸¸æˆç»“æŸç•Œé¢
                finalScoreDisplay.textContent = score;
                finalKeysDisplay.textContent = keysCollected;
                finalCoinsDisplay.textContent = coinsCollected;
                gameOverScreen.style.display = 'flex';
                
                // æ’­æ”¾æ¸¸æˆç»“æŸéŸ³æ•ˆ
                playSound('gameover');
            }
            
            // æ ¹æ®è¡¨ç°è°ƒæ•´åŸºç¡€é€Ÿåº¦
            if (score < 20) {
                gameData.baseSpeed = Math.max(0.8, gameData.baseSpeed - 0.1);
            } else if (score > 50) {
                gameData.baseSpeed = Math.min(2, gameData.baseSpeed + 0.1);
            }
        }
        
        // æ‰“å¼€å•†åº—
        function openShop() {
            shopScreen.style.display = 'flex';
            startScreen.style.display = 'none';
            gameOverScreen.style.display = 'none';
            newRecordScreen.style.display = 'none';
            
            // æ›´æ–°é‡‘å¸æ˜¾ç¤º
            totalCoinsDisplay.textContent = gameData.totalCoins;
            
            // ç”Ÿæˆå•†åº—ç‰©å“
            renderShopItems();
        }
        
        // æ¸²æŸ“å•†åº—ç‰©å“
        function renderShopItems() {
            shopItemsContainer.innerHTML = '';
            
            skins.forEach(skin => {
                const isUnlocked = gameData.unlockedSkins.includes(skin.id);
                const isSelected = playerSkin === skin.id;
                
                const item = document.createElement('div');
                item.className = `shop-item ${isSelected ? 'selected' : ''}`;
                item.innerHTML = `
                    <div class="shop-item-icon">${skin.emoji}</div>
                    <div class="shop-item-name">${skin.name}</div>
                    ${isUnlocked 
                        ? `<div class="shop-item-status">${isSelected ? 'å·²é€‰æ‹©' : 'å·²è§£é”'}</div>`
                        : `<div class="shop-item-price">ğŸ’°${skin.price}</div>`
                    }
                `;
                
                if (isUnlocked) {
                    item.addEventListener('click', () => {
                        if (!isSelected) {
                            playerSkin = skin.id;
                            updatePlayerSkin();
                            gameData.selectedSkin = skin.id;
                            renderShopItems();
                        }
                    });
                } else if (gameData.totalCoins >= skin.price) {
                    item.addEventListener('click', () => {
                        if (confirm(`ç¡®å®šè¦èŠ±è´¹ ${skin.price} é‡‘å¸è´­ä¹°ã€${skin.name}ã€‘çš®è‚¤å—ï¼Ÿ`)) {
                            gameData.totalCoins -= skin.price;
                            gameData.unlockedSkins.push(skin.id);
                            playerSkin = skin.id;
                            gameData.selectedSkin = skin.id;
                            updatePlayerSkin();
                            totalCoinsDisplay.textContent = gameData.totalCoins;
                            renderShopItems();
                        }
                    });
                } else {
                    item.style.opacity = '0.6';
                }
                
                shopItemsContainer.appendChild(item);
            });
        }
        
        // ä¿å­˜æ¸¸æˆæ•°æ®
        function saveGameData() {
            const dataStr = JSON.stringify(gameData);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = 'bomb_dodge_save.json';
            a.click();
            
            URL.revokeObjectURL(url);
            
            alert('æ¸¸æˆè¿›åº¦å·²ä¿å­˜ä¸ºæ–‡ä»¶ï¼Œä¸‹æ¬¡æ¸¸æˆæ—¶å¯ä»¥é€šè¿‡å¯¼å…¥ç»§ç»­æ¸¸ç©ï¼');
            
            // è¿”å›ä¸»ç•Œé¢
            returnToMainMenu();
        }
        
        // åŠ è½½æ¸¸æˆæ•°æ®
        function loadGameData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const loadedData = JSON.parse(e.target.result);
                    gameData = {
                        ...gameData,
                        ...loadedData,
                        baseSpeed: loadedData.baseSpeed || 1
                    };
                    playerSkin = gameData.selectedSkin || 'default';
                    totalCoins = gameData.totalCoins || 0;
                    alert('æ¸¸æˆè¿›åº¦å·²åŠ è½½ï¼');
                } catch (error) {
                    alert('åŠ è½½å¤±è´¥ï¼Œæ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®ï¼');
                }
            };
            reader.readAsText(file);
        }
        
        // è¿”å›ä¸»ç•Œé¢
        function returnToMainMenu() {
            gameRunning = false;
            cancelAnimationFrame(animationId);
            
            // æ¸…é™¤æ‰€æœ‰æ¸¸æˆå…ƒç´ 
            document.querySelectorAll('.bomb, .treasure, .explosion, .particle, .effect-text, .confetti').forEach(el => el.remove());
            
            // æ˜¾ç¤ºä¸»ç•Œé¢
            startScreen.style.display = 'flex';
            gameOverScreen.style.display = 'none';
            shopScreen.style.display = 'none';
            newRecordScreen.style.display = 'none';
            confirmDialog.style.display = 'none';
        }
        
        // ç®€å•éŸ³æ•ˆç³»ç»Ÿ
        function playSound(type) {
            // åœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¿™é‡Œå¯ä»¥æ’­æ”¾éŸ³é¢‘æ–‡ä»¶
            // ä¸ºäº†ç¤ºä¾‹ç®€æ´ï¼Œæˆ‘ä»¬åªæ¨¡æ‹Ÿæ§åˆ¶å°è¾“å‡º
            console.log(`æ’­æ”¾éŸ³æ•ˆ: ${type}`);
        }
        
        // äº‹ä»¶ç›‘å¬
        startBtn.addEventListener('click', startGame);
        restartBtn.addEventListener('click', returnToMainMenu);
        exitBtn.addEventListener('click', saveGameData);
        shopBtn.addEventListener('click', openShop);
        loadBtn.addEventListener('click', () => fileInput.click());
        backBtn.addEventListener('click', returnToMainMenu);
        continueBtn.addEventListener('click', returnToMainMenu);
        confirmYes.addEventListener('click', useKeyToRevive);
        confirmNo.addEventListener('click', continueWithoutRevive);
        
        // é”®ç›˜æ§åˆ¶
        document.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowLeft' || e.key === 'ArrowRight') {
                keysPressed[e.key] = true;
            }
        });
        
        document.addEventListener('keyup', (e) => {
            if (e.key === 'ArrowLeft' || e.key === 'ArrowRight') {
                keysPressed[e.key] = false;
            }
        });
        
        // è§¦æ‘¸æ§åˆ¶ (ç§»åŠ¨ç«¯æ”¯æŒ)
        gameContainer.addEventListener('touchstart', (e) => {
            e.preventDefault();
            if (gameRunning) {
                touchX = e.touches[0].clientX - gameContainer.getBoundingClientRect().left;
            }
        });
        
        gameContainer.addEventListener('touchmove', (e) => {
            e.preventDefault();
            if (gameRunning) {
                touchX = e.touches[0].clientX - gameContainer.getBoundingClientRect().left;
            }
        });
        
        gameContainer.addEventListener('touchend', () => {
            touchX = null;
        });
        
        // çª—å£å¤§å°æ”¹å˜æ—¶è°ƒæ•´æ¸¸æˆå°ºå¯¸
        window.addEventListener('resize', () => {
            adjustGameSize();
        });
        
        // æ–‡ä»¶å¯¼å…¥
        const fileInput = document.createElement('input');
        fileInput.type = 'file';
        fileInput.accept = '.json';
        fileInput.style.display = 'none';
        fileInput.addEventListener('change', loadGameData);
        document.body.appendChild(fileInput);
        
        // åˆå§‹åŒ–æ˜¾ç¤ºå¼€å§‹ç•Œé¢
        startScreen.style.display = 'flex';
        adjustGameSize();
        
        // å°è¯•åŠ è½½æœ¬åœ°å­˜å‚¨çš„æ¸¸æˆæ•°æ®
        if (localStorage.getItem('bombDodgeSave')) {
            try {
                gameData = JSON.parse(localStorage.getItem('bombDodgeSave'));
                playerSkin = gameData.selectedSkin || 'default';
                totalCoins = gameData.totalCoins || 0;
            } catch (e) {
                console.log('åŠ è½½æœ¬åœ°å­˜å‚¨å¤±è´¥', e);
            }
        }
        
        // æ¸¸æˆå…³é—­å‰ä¿å­˜æ•°æ®
        window.addEventListener('beforeunload', () => {
            localStorage.setItem('bombDodgeSave', JSON.stringify(gameData));
        });
    </script>
</body>
</html>